#!/usr/bin/env bash

function main {
  set -exfu 

  local mpserver="$1"; shift
  local mphost="$1"; shift
  
  local mpserverip="$(m list --format json | jq -r --arg mp $mpserver '.list[] | select(.name == $mp) | .ipv4[0]')"
  local mpip=

  while [[ -z "${mpip}" ]]; do
    mpip="$(m list --format json | jq -r --arg mp $mphost '.list[] | select(.name == $mp) | .ipv4[0]')"
  done

  k3sup join --ip "${mpip}" --server-ip "${mpserverip}" --user ubuntu --server-user ubuntu \
    --k3s-extra-args "--disable-network-policy --no-flannel --node-ip=$mpip" "$@"
}

main "$@"
