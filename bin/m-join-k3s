#!/usr/bin/env bash

function main {
  set -exfu

  local mphost="$1"; shift
  local mpserver="$1"; shift
  
  local mpip=
  while [[ -z "${mpip}" ]]; do
    mpip="$(m info --format json $mphost | jq -r --arg mp $mphost '.info[$mp].ipv4[0]')"
  done

  local mpts="$(m info --format json "$mphost" | jq -r --arg mp $mphost '.info[$mp].ipv4[1]')"

  local mpserverip="$(m info --format json $mpserver | jq -r --arg mp $mpserver '.info[$mp].ipv4[0]')"

  k3sup join \
    --ip "${mpip}" --user ubuntu --server-ip "${mpserverip}" --server-user ubuntu \
    --k3s-extra-args "--no-flannel --node-ip=$mpip --node-external-ip $mpts" "$@"
}

main "$@"
