#!/usr/bin/env bash

function main {
  set -exfu

  local mphost="$1"; shift
  local context="$1"; shift
  
  local mpip="$(m list --format json | jq -r --arg mp $mphost '.list[] | select(.name == $mp) | .ipv4[0]')"

  k3sup install --cluster \
    --ip $mpip --user ubuntu \
    --local-path .kube/config --merge --context "$context" \
    --k3s-extra-args "--flannel-backend=none --no-flannel --disable-network-policy --disable traefik --disable servicelb --bind-address=$mpip --advertise-address=$mpip --node-ip=$mpip" "$@"
}

main "$@"
